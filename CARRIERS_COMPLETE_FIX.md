# رفع کامل مشکلات سیستم اپراتورها

## مشکلات حل شده

### 1. ❌ خطای CHECK constraint هنگام ثبت اپراتور جدید
**مشکل:** `new row for relation "sim_cards" violates check constraint "sim_cards_carrier_check"`

**راه حل:** حذف constraint قدیمی که فقط سه اپراتور ثابت را قبول می‌کرد

**فایل SQL:** `msim-new/supabase/remove-carrier-check-constraint.sql`

### 2. ❌ تغییر نام اپراتور باعث عدم نمایش شماره‌های قبلی می‌شد
**مشکل:** وقتی نام فارسی اپراتور تغییر می‌کرد، شماره‌های قبلی که با نام قدیمی ثبت شده بودند دیگر نمایش داده نمی‌شدند

**راه حل:** استفاده از Context API برای مدیریت مرکزی اپراتورها و refresh خودکار

**فایل جدید:** `msim-new/contexts/CarriersContext.tsx`

### 3. ❌ تغییر ترتیب اپراتورها در صفحه اصلی اعمال نمی‌شد
**مشکل:** تغییر `display_order` در پنل ادمین تاثیری در ترتیب نمایش نداشت

**راه حل:** استفاده از Context که هر 30 ثانیه و بعد از هر تغییر refresh می‌شود

### 4. ❌ لیست اپراتورها در Header و Footer ثابت بود
**مشکل:** منوهای Header و Footer همچنان سه اپراتور ثابت را نمایش می‌دادند

**راه حل:** به‌روزرسانی Header و Footer برای استفاده از Context

### 5. ❌ لینک "مشاهده همه" برای اپراتورهای جدید به صفحه رایتل می‌رفت
**مشکل:** تمام اپراتورهای جدید به صفحه رایتل redirect می‌شدند

**راه حل:** استفاده از فیلد `name` (انگلیسی) به جای mapping ثابت

## فایل‌های ایجاد شده

1. `msim-new/supabase/remove-carrier-check-constraint.sql` - حذف constraint
2. `msim-new/contexts/CarriersContext.tsx` - Context برای مدیریت اپراتورها

## فایل‌های به‌روز شده

1. `msim-new/App.tsx` - اضافه کردن CarriersProvider
2. `msim-new/components/AdminCarriersManagement.tsx` - refresh بعد از تغییرات
3. `msim-new/pages/HomePage.tsx` - استفاده از Context
4. `msim-new/pages/SellerDashboard.tsx` - استفاده از Context
5. `msim-new/components/AdvancedSearch.tsx` - استفاده از Context
6. `msim-new/components/Header.tsx` - منوی داینامیک
7. `msim-new/components/Footer.tsx` - لینک‌های داینامیک
8. `msim-new/pages/CarrierSimsPage.tsx` - استفاده از name به جای slug map

## نحوه اجرا

### مرحله 1: اجرای SQL
```sql
-- در Supabase SQL Editor اجرا کنید:
-- فایل: msim-new/supabase/remove-carrier-check-constraint.sql
```

### مرحله 2: رفرش صفحه
بعد از اجرای SQL، صفحه را رفرش کنید تا Context بارگذاری شود.

## ویژگی‌های جدید

✅ **مدیریت کامل اپراتورها:**
- اضافه کردن اپراتور جدید با هر نامی
- ویرایش نام فارسی و انگلیسی
- تغییر ترتیب نمایش
- فعال/غیرفعال کردن

✅ **به‌روزرسانی خودکار:**
- Context هر 30 ثانیه refresh می‌شود
- بعد از هر تغییر در پنل ادمین، بلافاصله refresh می‌شود
- تمام صفحات به صورت خودکار به‌روز می‌شوند

✅ **نمایش داینامیک:**
- صفحه اصلی: بخش‌های اپراتورها داینامیک
- Header: منوی dropdown داینامیک
- Footer: لینک‌های اپراتورها داینامیک
- فرم ثبت سیمکارت: dropdown اپراتورهای فعال
- جستجوی پیشرفته: فیلتر اپراتورهای فعال

✅ **مسیریابی صحیح:**
- هر اپراتور با `name` (انگلیسی) خودش شناسایی می‌شود
- لینک "مشاهده همه" به صفحه صحیح می‌رود
- صفحه اپراتور نامعتبر پیام مناسب نمایش می‌دهد

## ساختار دیتابیس

```sql
CREATE TABLE carriers (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,        -- نام انگلیسی (برای URL)
    name_fa VARCHAR(100) NOT NULL,            -- نام فارسی (برای نمایش)
    is_active BOOLEAN DEFAULT true,           -- فعال/غیرفعال
    display_order INTEGER DEFAULT 0,          -- ترتیب نمایش
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

## مثال استفاده

### اضافه کردن اپراتور جدید:
1. وارد پنل ادمین شوید
2. تنظیمات → عمومی → مدیریت اپراتورها
3. کلیک روی "➕ افزودن اپراتور"
4. نام انگلیسی: `taliya` (برای URL)
5. نام فارسی: `تالیا` (برای نمایش)
6. ترتیب نمایش: `4`
7. ذخیره

### نتیجه:
- بلافاصله در صفحه اصلی نمایش داده می‌شود
- در Header و Footer ظاهر می‌شود
- در فرم ثبت سیمکارت قابل انتخاب است
- لینک: `/carrier/taliya`

## تست

1. ✅ اضافه کردن اپراتور جدید
2. ✅ ثبت سیمکارت با اپراتور جدید
3. ✅ تغییر نام فارسی اپراتور
4. ✅ تغییر ترتیب نمایش
5. ✅ غیرفعال کردن اپراتور
6. ✅ کلیک روی "مشاهده همه" برای اپراتور جدید
7. ✅ جستجو با فیلتر اپراتور جدید
8. ✅ نمایش در Header و Footer

## نکات مهم

⚠️ **نام انگلیسی (name):**
- باید یکتا باشد
- فقط حروف انگلیسی، اعداد و خط تیره
- برای URL استفاده می‌شود
- نباید تغییر کند (چون در URL است)

⚠️ **نام فارسی (name_fa):**
- برای نمایش به کاربر
- می‌تواند تغییر کند
- در جدول sim_cards ذخیره می‌شود

⚠️ **ترتیب نمایش (display_order):**
- عدد کوچکتر = بالاتر
- می‌تواند تکراری باشد
- برای مرتب‌سازی استفاده می‌شود

## خلاصه

تمام مشکلات سیستم اپراتورها حل شد. حالا می‌توانید:
- اپراتورهای جدید اضافه کنید
- نام‌ها را تغییر دهید
- ترتیب را تنظیم کنید
- همه چیز به صورت خودکار در سراسر سایت به‌روز می‌شود
