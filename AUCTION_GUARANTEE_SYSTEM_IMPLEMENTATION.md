# سیستم حراجی با مکانیزم ضمانت‌نامه - گزارش پیاده‌سازی

## خلاصه

سیستم حراجی شفاف و منصفانه با مکانیزم ضمانت‌نامه و فرآیند انتخاب برنده‌ی چند مرحله‌ای کامل به‌طور موفق پیاده‌سازی شده است.

---

## ۱. تغییرات ساختار دیتابیس

### فایل: `supabase/add-auction-guarantee-system.sql`

جداول جدید ایجاد شده:

#### ۱.۱ `auction_participants`
شامل تمام شرکت‌کنندگان هر حراجی:
- `auction_id`: شناسه‌ی حراجی
- `sim_card_id`: شناسه‌ی سیمکارت
- `user_id`: شناسه‌ی کاربر
- `highest_bid`: بالاترین پیشنهاد
- `bid_count`: تعداد پیشنهادها
- `rank`: رتبه نهایی (بعد از پایان حراجی)
- `guarantee_deposit_amount`: مبلغ حق ضمانت
- `guarantee_deposit_blocked`: وضعیت مسدود بودن
- `is_top_3`: آیا از ۳ برنده‌ی اول است

#### ۱.۲ `guarantee_deposits`
ردیابی حق ضمانت‌ها:
- `user_id`: کاربر
- `auction_id`: حراجی
- `amount`: مبلغ
- `status`: blocked | released | burned
- `reason`: دلیل تغییر وضعیت

#### ۱.۳ `auction_winner_queue`
صف شرکت‌کنندگان برای پرداخت:
- `winner_rank`: رتبه‌ی برنده (۱، ۲، ۳)
- `payment_status`: pending | completed | failed | burned
- `payment_deadline`: مهلت‌ی پرداخت (۴۸ ساعت)
- `remaining_amount`: مبلغ باقی‌مانده

#### ۱.۴ `auction_payments`
ریخت‌و‌ریز پرداخت‌ها:
- تمام اطلاعات مالی مربوط به هر حراجی

### تغییرات جدول `auction_details`
- `status`: active | ended | pending_payment | completed | cancelled
- `base_price`: قیمت پایه
- `guarantee_deposit_amount`: مبلغ حق ضمانت
- `final_winner_id`: برنده‌ی نهایی

---

## ۲. تغییرات TypeScript Types

### فایل: `types.ts`

تایپ‌های جدید:
- `AuctionParticipant`: شرکت‌کننده در حراجی
- `GuaranteeDeposit`: حق ضمانت
- `AuctionWinnerQueue`: صف برندگان
- `AuctionPayment`: ریخت‌و‌ریز پرداخت
- `AuctionStatus`: نوع وضعیت حراجی

---

## ۳. توابع API

### فایل: `services/auction-guarantee-system.ts`

#### ۳.۱ `checkGuaranteeDepositBalance()`
**هدف:** بررسی موجودی کافی برای حق ضمانت

**منطق:**
```
حق ضمانت = 5% از قیمت پایه
موجودی موردنیاز = پیشنهاد + حق ضمانت
```

**خروجی:**
- `hasBalance`: آیا کاربر موجودی کافی دارد
- `requiredAmount`: مبلغ موردنیاز
- `currentBalance`: موجودی فعلی

#### ۳.۲ `placeBidWithGuaranteeDeposit()`
**هدف:** ثبت پیشنهاد با مکانیزم ضمانت‌نامه

**فرآیند:**
1. بررسی حراجی فعال است
2. بررسی پیشنهاد بیشتر از پیشنهاد فعلی است
3. بررسی اولین‌بار شرکت کاربر در این حراجی
4. اگر اولین بار: مسدود کردن ۵% حق ضمانت
5. مسدود کردن مبلغ پیشنهاد
6. رهاسازی پیشنهاد قبلی برنده‌ی قبل
7. اطلاع‌رسانی به فروشنده و بیدار‌کننده

#### ۳.۳ `processAuctionEnding()`
**هدف:** پردازش پایان حراجی

**مراحل:**
1. دریافت تمام شرکت‌کنندگان و رتبه‌بندی
2. انتخاب ۳ برنده‌ی اول
3. رهاسازی حق ضمانت برنده‌های بعدی
4. ایجاد صف پرداخت برای ۳ برنده
5. اطلاع‌رسانی برنده‌ی اول

#### ۳.۴ `checkAndProcessPaymentDeadlines()`
**هدف:** بررسی مهلت‌های منقضی شده

**فرآیند:**
- اجرا شود در: هر رفرش صفحه (Hook)
- دریافت: تمام پرداخت‌های معلق با مهلت منقضی
- برای هر پرداخت: فراخوانی `handleExpiredPaymentDeadline()`

#### ۳.۵ `handleExpiredPaymentDeadline()`
**هدف:** مدیریت منقضی شدن مهلت پرداخت

**اقدامات:**
1. علامت‌گذاری وضعیت به "failed"
2. سوزاندن حق ضمانت (حذف از سیستم)
3. اطلاع‌رسانی بیدار‌کننده
4. اطلاع‌رسانی برنده‌ی بعدی
5. اگر برنده‌ای نباشد: لغو حراجی

#### ۳.۶ `processAuctionWinnerPayment()`
**هدف:** تکمیل پرداخت برنده

**مراحل:**
1. علامت‌گذاری پرداخت به "completed"
2. بروزرسانی وضعیت حراجی به "completed"
3. تغییر وضعیت سیمکارت به "sold"
4. محاسبه و کسر ۲% کمیسیون
5. واریز مبلغ به حساب فروشنده
6. ایجاد رکورد کمیسیون
7. اطلاع‌رسانی طرفین

#### ۳.۷ `completeAuctionFlow()`
**هدف:** تکمیل جریان حراجی و شروع تحویل خط

**فرآیند:**
1. تشخیص نوع خط (فعال/غیرفعال)
2. ایجاد فرمان خرید برای تحویل خط
3. اطلاع‌رسانی خریدار و فروشنده

---

## ۴. Components

### `AdminAuctionParticipantsPanel.tsx`
**مقصد:** نمایش تمام شرکت‌کنندگان برای مدیران

**ویژگی‌ها:**
- لیست کامل شرکت‌کنندگان
- نمایش رتبه، نام، پیشنهاد، تعداد پیشنهاد
- علامت‌گذاری برنده‌های احتمالی (۳ اول)
- وضعیت حق ضمانت

### `UserAuctionView.tsx`
**مقصد:** نمایش حفاظت‌شده‌ی حراجی برای کاربران عادی

**ویژگی‌ها:**
- نمایش تنها بالاترین پیشنهاد
- نمایش نام بیدار‌کننده
- بروزرسانی هر ۳۰ ثانیه
- توضیح حریم خصوصی

---

## ۵. Hooks

### `useAuctionPaymentChecker.ts`
**هدف:** بررسی مهلت‌های پرداخت در هر رفرش صفحه

**اجرا:**
```typescript
import useAuctionPaymentChecker from '../hooks/useAuctionPaymentChecker';

function MyComponent() {
  useAuctionPaymentChecker(); // Runs automatically
  return <div>...</div>;
}
```

---

## ۶. جریان کاربر

### ۶.۱ شرکت‌کننده در حراجی

```
۱. مشاهده‌ی حراجی
   ↓
۲. بررسی موجودی (۵% حق ضمانت + پیشنهاد)
   ↓
۳. ثبت پیشنهاد
   ├─ اگر اولین بار: مسدود شدن ۵% حق ضمانت
   └─ مسدود شدن مبلغ پیشنهاد
   ↓
۴. اطلاع‌رسانی (برنده شدن/شامل شدن)
   ↓
۵. انتظار برای پایان حراجی
```

### ۶.۲ برنده‌ی حراجی

```
۱. پایان حراجی → اطلاع‌رسانی برنده
   ↓
۲. مهلت ۴۸ ساعتی برای پرداخت
   ├─ اگر پرداخت کند → تکمیل حراجی
   └─ اگر پرداخت نکند → سوزاندن حق ضمانت + رفتن به برنده‌ی بعدی
   ↓
۳. شروع فرآیند تحویل خط
   ↓
۴. تکمیل فرمان خرید
```

---

## ۷. مثال عملی

### سناریو: حراجی سیمکارت ۰۹۱۲۳۴۵۶۷۸

**قیمت پایه:** ۱۰,۰۰۰,۰۰۰ تومان
**حق ضمانت:** ۵۰۰,۰۰۰ تومان

#### مرحله ۱: شرکت‌کنندگان

| نام | پیشنهاد | حق ضمانت | رتبه |
|-----|---------|---------|------|
| علی | ۱۲,۰۰۰,۰۰۰ | ۵۰۰,۰۰۰ | ۱ ✅ |
| سارا | ۱۱,۵۰۰,۰۰۰ | ۵۰۰,۰۰۰ | ۲ ✅ |
| محمد | ۱۱,۰۰۰,۰۰۰ | ۵۰۰,۰۰۰ | ۳ ✅ |
| فاطمه | ۱۰,۵۰۰,۰۰۰ | ۵۰۰,۰۰۰ | ۴ ❌ |
| رضا | ۱۰,۲۰۰,۰۰۰ | ۵۰۰,۰۰۰ | ۵ ❌ |

#### مرحله ۲: پایان حراجی
- فاطمه و رضا: حق ضمانت ۵۰۰,۰۰۰ برگشت داده شد ✅

#### مرحله ۳: علی (برنده اول)
- **مهلت:** ۴۸ ساعت
- **مبلغ قابل پرداخت:** ۱۲,۰۰۰,۰۰۰ - ۵۰۰,۰۰۰ = ۱۱,۵۰۰,۰۰۰
- **پرداخت کرد؟** ✅ بله
  - حراجی تکمیل شد
  - ۲% کمیسیون کسر شد: ۲۴۰,۰۰۰
  - فروشنده دریافت: ۱۱,۷۶۰,۰۰۰

---

## ۸. نکات مهم

### ۸.۱ حریم خصوصی
- کاربران عادی: تنها بالاترین پیشنهاد و نام بیدار‌کننده
- مدیران: لیست کامل با تمام اطلاعات

### ۸.۲ امنیت مالی
- حق ضمانت مسدود است (غیر قابل استفاده)
- تنها کمیسیون ۲% از سایت کسر می‌شود
- بقیه‌ی مبلغ به فروشنده واریز می‌شود

### ۸.۳ خودکار‌سازی
- هیچ cron job نیازی نیست
- بررسی مهلت‌ها در هر رفرش صفحه
- اطلاع‌رسانی‌های خودکار

---

## ۹. توابع قابل‌استفاده

```typescript
import api from '../services/api-supabase';

// بررسی موجودی
const { hasBalance, requiredAmount } = await api.checkGuaranteeDepositBalance(userId, auctionId, basePrice);

// ثبت پیشنهاد
await api.placeBidWithGuaranteeDeposit(simId, auctionId, bidderId, amount, basePrice);

// پایان حراجی
await api.processAuctionEnding(auctionId);

// بررسی مهلت‌ها (خودکار)
await api.checkAndProcessPaymentDeadlines();

// پرداخت برنده
await api.processAuctionWinnerPayment(winnerQueueId, auctionId);

// تکمیل جریان
await api.completeAuctionFlow(auctionId, winnerUserId, simCardId);
```

---

## ۱۰. مراجع

- SQL Schema: `supabase/add-auction-guarantee-system.sql`
- API: `services/auction-guarantee-system.ts`
- Types: `types.ts`
- Components: `components/AdminAuctionParticipantsPanel.tsx`, `components/UserAuctionView.tsx`
- Hooks: `hooks/useAuctionPaymentChecker.ts`
