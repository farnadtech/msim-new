# ✅ چک لیست استقرار سیستم احراز هویت (KYC)

## مرحله 1: دیتابیس (Supabase)

### اجرای اسکریپت‌های SQL
- [ ] اجرای `supabase/create-kyc-verification-table.sql`
  - جدول `kyc_verifications` ایجاد شود
  - فیلدهای `is_verified` و `kyc_submitted_at` به جدول `users` اضافه شوند
  - RLS policies فعال شوند

- [ ] اجرای `supabase/add-activation-settings.sql`
  - تنظیم `buyer_can_receive_activation_code` اضافه شود
  - تنظیمات KYC اضافه شوند

- [ ] اجرای `supabase/create-kyc-storage-bucket.sql`
  - Bucket `kyc-documents` ایجاد شود
  - RLS policies برای storage تنظیم شوند
  - محدودیت‌های فایل تنظیم شوند

### بررسی دیتابیس
- [ ] بررسی جدول `kyc_verifications` در Supabase Dashboard
- [ ] بررسی Storage Bucket `kyc-documents`
- [ ] تست آپلود یک فایل تستی
- [ ] بررسی RLS policies

## مرحله 2: تنظیمات اولیه

### تنظیمات ادمین
- [ ] ورود به پنل ادمین
- [ ] رفتن به صفحه تنظیمات
- [ ] بررسی وجود دسته‌بندی "احراز هویت"
- [ ] تنظیم مقادیر اولیه:
  - [ ] `kyc_required` = true/false
  - [ ] `kyc_required_for_sellers` = true/false
  - [ ] `kyc_required_for_buyers` = true/false
  - [ ] `buyer_can_receive_activation_code` = false (پیش‌فرض)

## مرحله 3: تست عملکرد

### تست احراز هویت - کاربر عادی
- [ ] ایجاد حساب کاربری جدید (خریدار)
- [ ] تلاش برای خرید سیم‌کارت
- [ ] بررسی هدایت به صفحه احراز هویت
- [ ] پر کردن فرم با اطلاعات تستی
- [ ] آپلود تصاویر تستی
- [ ] ارسال درخواست
- [ ] بررسی پیام موفقیت
- [ ] بررسی وضعیت "در انتظار بررسی"

### تست پنل ادمین
- [ ] ورود با حساب ادمین
- [ ] رفتن به `/admin/kyc-management`
- [ ] مشاهده درخواست تستی
- [ ] بررسی نمایش تصاویر
- [ ] تایید درخواست
- [ ] بررسی تغییر وضعیت به "تایید شده"

### تست دسترسی پس از تایید
- [ ] ورود با حساب کاربری تست
- [ ] بررسی نمایش وضعیت "تایید شده"
- [ ] تلاش برای خرید سیم‌کارت
- [ ] بررسی دسترسی کامل

### تست رد درخواست
- [ ] ایجاد حساب کاربری جدید
- [ ] ارسال درخواست KYC
- [ ] رد درخواست توسط ادمین با دلیل
- [ ] بررسی نمایش پیام رد
- [ ] بررسی امکان ارسال مجدد

### تست کنترل دریافت کد فعال‌سازی
- [ ] تنظیم `buyer_can_receive_activation_code` = false
- [ ] تلاش برای خرید سیم‌کارت صفر
- [ ] بررسی نمایش فقط گزینه "دریافت فیزیکی"
- [ ] بررسی نمایش پیام اطلاع‌رسانی
- [ ] تنظیم `buyer_can_receive_activation_code` = true
- [ ] بررسی نمایش هر دو گزینه

## مرحله 4: تست امنیت

### RLS Policies
- [ ] کاربر A نمی‌تواند KYC کاربر B را ببیند
- [ ] کاربر نمی‌تواند KYC تایید شده خود را ویرایش کند
- [ ] ادمین می‌تواند همه KYC ها را ببیند
- [ ] ادمین می‌تواند همه KYC ها را ویرایش کند

### Storage Security
- [ ] کاربر A نمی‌تواند فایل‌های کاربر B را ببیند
- [ ] کاربر نمی‌تواند در پوشه دیگران آپلود کند
- [ ] ادمین می‌تواند همه فایل‌ها را ببیند
- [ ] فایل‌های بزرگتر از 10MB رد می‌شوند
- [ ] فرمت‌های غیرمجاز رد می‌شوند

## مرحله 5: تست تجربه کاربری

### صفحه احراز هویت
- [ ] فرم به درستی نمایش داده می‌شود
- [ ] Validation ها کار می‌کنند
- [ ] پیام‌های خطا واضح هستند
- [ ] آپلود فایل روان است
- [ ] پیش‌نمایش تصاویر نمایش داده می‌شود
- [ ] دکمه ارسال غیرفعال می‌شود در حین پردازش

### پنل ادمین
- [ ] لیست درخواست‌ها به درستی نمایش داده می‌شود
- [ ] فیلترها کار می‌کنند
- [ ] تصاویر در اندازه بزرگ باز می‌شوند
- [ ] فرم تایید/رد کار می‌کند
- [ ] یادداشت‌های ادمین ذخیره می‌شوند

### KYCGuard
- [ ] کاربران احراز نشده مسدود می‌شوند
- [ ] پیام‌های راهنما نمایش داده می‌شوند
- [ ] دکمه‌های هدایت کار می‌کنند
- [ ] ادمین‌ها مسدود نمی‌شوند

## مرحله 6: تست عملکرد در مرورگرهای مختلف

- [ ] Chrome
- [ ] Firefox
- [ ] Safari
- [ ] Edge
- [ ] موبایل (Chrome)
- [ ] موبایل (Safari)

## مرحله 7: تست Responsive

- [ ] Desktop (1920x1080)
- [ ] Laptop (1366x768)
- [ ] Tablet (768x1024)
- [ ] Mobile (375x667)

## مرحله 8: بررسی Performance

- [ ] زمان بارگذاری صفحه احراز هویت
- [ ] زمان آپلود تصاویر
- [ ] زمان بارگذاری پنل ادمین
- [ ] زمان تایید/رد درخواست

## مرحله 9: مستندات

- [ ] خواندن `KYC_AND_ACTIVATION_SYSTEM_GUIDE.md`
- [ ] خواندن `IMPLEMENTATION_SUMMARY_KYC.md`
- [ ] آشنایی با API ها
- [ ] آشنایی با تنظیمات

## مرحله 10: آموزش تیم

- [ ] آموزش ادمین‌ها برای بررسی درخواست‌ها
- [ ] آموزش پشتیبانی برای راهنمایی کاربران
- [ ] آموزش توسعه‌دهندگان برای نگهداری

## مرحله 11: Monitoring

- [ ] تنظیم لاگ‌گیری
- [ ] تنظیم اعلان‌ها برای خطاها
- [ ] تنظیم گزارش‌های روزانه
- [ ] بررسی آمار استفاده

## مرحله 12: Backup

- [ ] Backup از دیتابیس
- [ ] Backup از Storage
- [ ] Backup از تنظیمات
- [ ] تست بازیابی

## مرحله 13: استقرار نهایی

- [ ] Merge کردن تغییرات به branch اصلی
- [ ] Deploy کردن به Production
- [ ] بررسی عملکرد در Production
- [ ] اطلاع‌رسانی به کاربران

## مرحله 14: پس از استقرار

- [ ] نظارت بر لاگ‌ها
- [ ] پاسخ به سوالات کاربران
- [ ] رفع باگ‌های احتمالی
- [ ] جمع‌آوری بازخورد

## نکات مهم

### قبل از استقرار
- ⚠️ حتما Backup بگیرید
- ⚠️ در محیط تست کامل تست کنید
- ⚠️ تیم را آموزش دهید
- ⚠️ مستندات را بخوانید

### در حین استقرار
- ⚠️ مرحله به مرحله پیش بروید
- ⚠️ هر مرحله را تست کنید
- ⚠️ لاگ‌ها را بررسی کنید
- ⚠️ در صورت مشکل، Rollback کنید

### پس از استقرار
- ⚠️ 24 ساعت اول را نظارت کنید
- ⚠️ به سوالات سریع پاسخ دهید
- ⚠️ آمار را بررسی کنید
- ⚠️ بازخورد جمع‌آوری کنید

## کوئری‌های مفید برای بررسی

```sql
-- بررسی تعداد کاربران احراز هویت شده
SELECT COUNT(*) FROM users WHERE is_verified = true;

-- بررسی تعداد درخواست‌های در انتظار
SELECT COUNT(*) FROM kyc_verifications WHERE status = 'pending';

-- بررسی آخرین درخواست‌ها
SELECT * FROM kyc_verifications ORDER BY created_at DESC LIMIT 10;

-- بررسی تنظیمات
SELECT * FROM site_settings WHERE setting_key LIKE '%kyc%' OR setting_key LIKE '%activation%';

-- بررسی Storage
SELECT COUNT(*) FROM storage.objects WHERE bucket_id = 'kyc-documents';
```

## در صورت بروز مشکل

### مشکلات رایج و راه حل

1. **تصاویر آپلود نمی‌شوند**
   - بررسی Storage Bucket
   - بررسی RLS policies
   - بررسی حجم فایل

2. **کاربر نمی‌تواند KYC ببیند**
   - بررسی RLS policies
   - بررسی user_id
   - بررسی auth token

3. **تنظیمات اعمال نمی‌شوند**
   - پاک کردن Cache
   - Refresh صفحه
   - بررسی دیتابیس

4. **ادمین نمی‌تواند تایید کند**
   - بررسی role ادمین
   - بررسی RLS policies
   - بررسی لاگ‌ها

## تماس با پشتیبانی

در صورت بروز مشکل:
1. لاگ‌های Console را ذخیره کنید
2. Screenshot از خطا بگیرید
3. مراحل بازتولید مشکل را یادداشت کنید
4. به مستندات مراجعه کنید

---

**یادآوری**: این چک لیست را قبل از استقرار نهایی کامل کنید!
