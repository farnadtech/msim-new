# راهنمای فیچر آگهی مجدد شماره‌های فروخته شده

## خلاصه تغییرات

این فیچر به فروشندگان اجازه می‌دهد که شماره‌های فروخته شده را دوباره آگهی کنند و آگهی‌های فروخته شده بعد از 1 روز به صورت خودکار پاک می‌شوند.

## چگونه کار می‌کند؟

### 1. سیستم Auto-Cleanup موجود
پروژه از قبل یک سیستم auto-cleanup دارد که در فایل `hooks/useAutoCleanup.ts` پیاده‌سازی شده است:

- این hook در `App.tsx` فراخوانی می‌شود
- هر بار که برنامه لود می‌شود، سیمکارت‌های فروخته شده قدیمی را چک می‌کند
- سیمکارت‌هایی که بیش از X روز فروخته شده‌اند را حذف می‌کند

### 2. تنظیمات قابل تغییر
تعداد روزها برای حذف خودکار در جدول `site_settings` ذخیره می‌شود:

```sql
setting_key: 'listing_auto_delete_days'
setting_value: '30' (پیش‌فرض)
```

## نحوه تغییر تنظیمات به 1 روز

### روش 1: از طریق پنل ادمین (توصیه می‌شود)

1. وارد پنل ادمین شوید
2. به بخش **⚙️ تنظیمات سایت** بروید
3. روی دکمه **📋 آگهی‌ها** کلیک کنید
4. تنظیم **"مدت زمان حذف خودکار آگهی‌های منقضی شده (روز)"** را پیدا کنید
5. مقدار را از `30` به `1` تغییر دهید
6. روی دکمه **ذخیره** کلیک کنید

### روش 2: از طریق SQL

فایل SQL آماده شده است در مسیر:
```
supabase/update-listing-auto-delete-to-1-day.sql
```

این فایل را در Supabase SQL Editor اجرا کنید:

```sql
UPDATE site_settings 
SET setting_value = '1', 
    description = 'مدت زمان حذف خودکار آگهی‌های فروخته شده (1 روز بعد از فروش)'
WHERE setting_key = 'listing_auto_delete_days';
```

### روش 3: از طریق اسکریپت TypeScript

اسکریپت آماده شده است:
```bash
npx tsx update-auto-delete-settings.ts
```

**نکته:** اگر این روش کار نکرد، احتمالاً به دلیل RLS policies است. از روش 1 یا 2 استفاده کنید.

## آگهی مجدد شماره‌های فروخته شده

### آیا شماره‌های تکراری مجاز هستند؟

**بله!** در حال حاضر هیچ constraint یا validation برای جلوگیری از ثبت شماره تکراری وجود ندارد.

این یعنی:
- ✅ فروشنده می‌تواند همان شماره را دوباره ثبت کند
- ✅ فروشنده دیگری هم می‌تواند همان شماره را ثبت کند
- ✅ هیچ محدودیتی در دیتابیس وجود ندارد

### فرآیند آگهی مجدد

1. **فروش اولیه:**
   - سیمکارت فروخته می‌شود
   - `status` به `sold` تغییر می‌کند
   - `sold_date` ثبت می‌شود

2. **بعد از 1 روز:**
   - سیستم auto-cleanup اجرا می‌شود
   - سیمکارت از دیتابیس حذف می‌شود

3. **آگهی مجدد:**
   - فروشنده می‌تواند همان شماره را دوباره ثبت کند
   - سیمکارت جدیدی با همان شماره ایجاد می‌شود
   - `status` برابر `available` است

## تست کردن فیچر

### تست دستی

1. یک سیمکارت بفروشید
2. تنظیمات را به 1 روز تغییر دهید
3. `sold_date` را به 2 روز پیش تغییر دهید (برای تست سریع):

```sql
UPDATE sim_cards 
SET sold_date = NOW() - INTERVAL '2 days'
WHERE id = YOUR_SIM_ID;
```

4. صفحه را رفرش کنید
5. سیمکارت باید حذف شود
6. حالا می‌توانید همان شماره را دوباره ثبت کنید

### تست خودکار

اسکریپت تست در `test-auto-cleanup.ts` (اگر وجود دارد) را اجرا کنید.

## کد مرتبط

### فایل‌های کلیدی:

1. **hooks/useAutoCleanup.ts** - Hook اصلی برای cleanup
2. **services/api-supabase.ts** - تابع `deleteExpiredListings()`
3. **services/settings-service.ts** - تابع `getListingAutoDeleteDays()`
4. **pages/AdminSettings.tsx** - پنل تنظیمات ادمین
5. **App.tsx** - فراخوانی hook

### توابع مهم:

```typescript
// دریافت تعداد روزها
const autoDeleteDays = await settingsService.getListingAutoDeleteDays();

// حذف سیمکارت‌های منقضی شده
const deletedCount = await api.deleteExpiredListings();
```

## نکات مهم

⚠️ **هشدارها:**

1. تغییر به 1 روز باعث می‌شود آگهی‌های فروخته شده خیلی سریع پاک شوند
2. اطمینان حاصل کنید که گزارش‌های فروش قبل از حذف ذخیره شده‌اند
3. جدول `commissions` تاریخچه فروش را نگه می‌دارد (حذف نمی‌شود)

✅ **مزایا:**

1. فروشندگان می‌توانند شماره‌های فروخته شده را دوباره آگهی کنند
2. دیتابیس تمیز می‌ماند
3. آگهی‌های قدیمی فضا نمی‌گیرند

## سوالات متداول

**Q: آیا تاریخچه فروش حذف می‌شود؟**
A: خیر، جدول `commissions` تاریخچه کامل فروش را نگه می‌دارد.

**Q: آیا می‌توانم تنظیمات را برای هر دسته متفاوت کنم؟**
A: خیر، در حال حاضر یک تنظیم برای همه وجود دارد.

**Q: چه اتفاقی برای حراجی‌های فروخته شده می‌افتد؟**
A: همانند سیمکارت‌های معمولی، بعد از 1 روز حذف می‌شوند.

**Q: آیا می‌توانم cleanup را غیرفعال کنم؟**
A: بله، تنظیم `listing_auto_delete_enabled` را به `false` تغییر دهید.

## پشتیبانی

اگر مشکلی پیش آمد:

1. لاگ‌های console را چک کنید
2. مطمئن شوید که hook در `App.tsx` فراخوانی می‌شود
3. تنظیمات را در پنل ادمین بررسی کنید
4. RLS policies را برای جدول `site_settings` چک کنید

---

**تاریخ ایجاد:** 2025-02-13
**نسخه:** 1.0.0
