# رفع مشکل تغییر نام اپراتور و ترتیب نمایش

## مشکلات

### 1. ❌ تغییر نام اپراتور باعث عدم نمایش سیمکارت‌های قبلی می‌شد
**علت:** فیلد `carrier` در جدول `sim_cards` به صورت TEXT ذخیره می‌شود و وقتی نام فارسی اپراتور تغییر می‌کند، سیمکارت‌های قدیمی همچنان نام قدیمی را دارند.

**راه حل:** ایجاد trigger که به صورت خودکار تمام سیمکارت‌ها را به‌روز می‌کند

### 2. ❌ ترتیب نمایش اپراتورها در صفحه اصلی تغییر نمی‌کرد
**علت:** Context هر 30 ثانیه refresh می‌شود اما تغییرات فوری نیستند

**راه حل:** اضافه کردن دکمه رفرش دستی + refresh خودکار بعد از هر تغییر

## راه حل کامل

### فایل SQL: `auto-update-carrier-names.sql`

این فایل شامل:
1. حذف CHECK constraint قدیمی
2. ایجاد function برای به‌روزرسانی خودکار
3. ایجاد trigger که وقتی `name_fa` تغییر می‌کند، تمام `sim_cards` را به‌روز می‌کند

### نحوه کار Trigger

```sql
-- وقتی نام فارسی اپراتور تغییر می‌کند:
UPDATE carriers SET name_fa = 'نام جدید' WHERE id = 1;

-- Trigger به صورت خودکار این کار را انجام می‌دهد:
UPDATE sim_cards 
SET carrier = 'نام جدید' 
WHERE carrier = 'نام قدیمی';
```

## نحوه اجرا

### مرحله 1: اجرای SQL
```bash
# در Supabase SQL Editor:
# فایل: msim-new/supabase/auto-update-carrier-names.sql
```

### مرحله 2: تست
1. وارد پنل ادمین شوید
2. تنظیمات → عمومی → مدیریت اپراتورها
3. یک اپراتور را ویرایش کنید و نام فارسی را تغییر دهید
4. روی دکمه "🔄 رفرش" کلیک کنید
5. به صفحه اصلی بروید - سیمکارت‌ها با نام جدید نمایش داده می‌شوند

### مرحله 3: تست ترتیب نمایش
1. ترتیب نمایش یک اپراتور را تغییر دهید
2. روی "🔄 رفرش" کلیک کنید
3. به صفحه اصلی بروید - ترتیب جدید اعمال شده است

## ویژگی‌های جدید

✅ **به‌روزرسانی خودکار نام:**
- تغییر نام فارسی اپراتور
- تمام سیمکارت‌ها به صورت خودکار به‌روز می‌شوند
- هیچ سیمکارتی گم نمی‌شود

✅ **دکمه رفرش:**
- رفرش دستی لیست اپراتورها
- رفرش Context سراسری
- نمایش پیام موفقیت

✅ **ترتیب نمایش:**
- تغییر `display_order` در پنل ادمین
- رفرش برای اعمال تغییرات
- ترتیب در صفحه اصلی، Header و Footer به‌روز می‌شود

## مثال استفاده

### تغییر نام اپراتور:
```
قبل: همراه اول
بعد: MCI

نتیجه:
- تمام سیمکارت‌های "همراه اول" به "MCI" تغییر می‌کنند
- در صفحه اصلی با نام "MCI" نمایش داده می‌شوند
- در Header و Footer به "MCI" تغییر می‌کنند
```

### تغییر ترتیب:
```
قبل:
1. همراه اول (display_order: 1)
2. ایرانسل (display_order: 2)
3. رایتل (display_order: 3)

تغییر: رایتل را به display_order: 1 تغییر دهید

بعد از رفرش:
1. رایتل (display_order: 1)
2. همراه اول (display_order: 1)
3. ایرانسل (display_order: 2)
```

## نکات مهم

⚠️ **نام انگلیسی (name):**
- نباید تغییر کند (چون در URL استفاده می‌شود)
- اگر تغییر دهید، لینک‌های قدیمی کار نمی‌کنند

⚠️ **نام فارسی (name_fa):**
- می‌تواند تغییر کند
- Trigger به صورت خودکار sim_cards را به‌روز می‌کند
- تغییرات فوری اعمال می‌شوند

⚠️ **ترتیب نمایش (display_order):**
- بعد از تغییر، روی "🔄 رفرش" کلیک کنید
- یا 30 ثانیه صبر کنید تا Context خودکار refresh شود
- صفحه اصلی را رفرش کنید تا تغییرات را ببینید

## تست کامل

### تست 1: تغییر نام
1. ✅ چند سیمکارت با اپراتور "همراه اول" ثبت کنید
2. ✅ نام فارسی را به "MCI" تغییر دهید
3. ✅ روی رفرش کلیک کنید
4. ✅ به صفحه اصلی بروید
5. ✅ سیمکارت‌ها با نام "MCI" نمایش داده می‌شوند

### تست 2: ترتیب نمایش
1. ✅ ترتیب اپراتورها را تغییر دهید
2. ✅ روی رفرش کلیک کنید
3. ✅ صفحه اصلی را رفرش کنید
4. ✅ ترتیب جدید اعمال شده است

### تست 3: Header و Footer
1. ✅ نام یا ترتیب اپراتور را تغییر دهید
2. ✅ روی رفرش کلیک کنید
3. ✅ صفحه را رفرش کنید
4. ✅ Header و Footer به‌روز شده‌اند

## خلاصه

✅ Trigger خودکار برای به‌روزرسانی نام اپراتور در sim_cards
✅ دکمه رفرش دستی در پنل ادمین
✅ Context هر 30 ثانیه refresh می‌شود
✅ تمام صفحات به صورت خودکار به‌روز می‌شوند

**نکته:** بعد از هر تغییر در پنل ادمین، روی دکمه "🔄 رفرش" کلیک کنید تا تغییرات فوری اعمال شوند.
