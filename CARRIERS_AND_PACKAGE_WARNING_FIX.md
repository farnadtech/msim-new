# رفع مشکل RLS اپراتورها و اضافه کردن هشدار تغییر پکیج

## تغییرات انجام شده

### 1. رفع مشکل RLS جدول carriers

**مشکل:**
- هنگام اضافه کردن اپراتور جدید خطا: `new row violates row-level security policy for table "carriers"`
- ویرایش و غیرفعال کردن اپراتورها انجام نمی‌شد

**راه حل:**
- RLS برای جدول `carriers` غیرفعال شد
- فایل‌های SQL به‌روز شدند:
  - `msim-new/supabase/create-carriers-table.sql` - فایل اصلی ایجاد جدول
  - `msim-new/supabase/fix-carriers-rls.sql` - فایل رفع مشکل (جدید)

**نحوه اجرا:**
1. در Supabase Dashboard وارد SQL Editor شوید
2. فایل `msim-new/supabase/fix-carriers-rls.sql` را اجرا کنید
3. حالا می‌توانید اپراتورها را اضافه، ویرایش و حذف کنید

### 2. اضافه کردن هشدار تغییر پکیج

**تغییرات:**
- در صفحه `SellerDashboard.tsx` هنگام خرید پکیج جدید، اگر فروشنده قبلاً پکیج دیگری داشته باشد، پیام هشدار نمایش داده می‌شود
- پیام: "⚠️ با تغییر پکیج، پکیج فعلی شما باطل و پکیج جدید فعال خواهد شد."
- پیام با رنگ زرد و آیکون هشدار نمایش داده می‌شود

**فایل تغییر یافته:**
- `msim-new/pages/SellerDashboard.tsx`

### 3. اتصال اپراتورها به دیتابیس در سراسر سایت

**مشکل:**
- اپراتورها به صورت ثابت در کد نوشته شده بودند
- تغییرات در پنل ادمین در سایت اعمال نمی‌شد

**راه حل:**
- تمام کامپوننت‌ها به‌روز شدند تا از جدول `carriers` بخوانند:
  - `HomePage.tsx` - صفحه اصلی حالا اپراتورها را از دیتابیس می‌خواند
  - `SellerDashboard.tsx` - فرم ثبت سیمکارت از اپراتورهای فعال استفاده می‌کند
  - `AdvancedSearch.tsx` - جستجوی پیشرفته اپراتورهای فعال را نمایش می‌دهد

**ویژگی‌های جدید:**
- اپراتورها به صورت داینامیک از دیتابیس بارگذاری می‌شوند
- فقط اپراتورهای فعال (`is_active = true`) نمایش داده می‌شوند
- ترتیب نمایش بر اساس `display_order` است
- اگر اپراتوری اضافه یا حذف شود، بلافاصله در سایت اعمال می‌شود

**فایل‌های تغییر یافته:**
- `msim-new/pages/HomePage.tsx`
- `msim-new/pages/SellerDashboard.tsx`
- `msim-new/components/AdvancedSearch.tsx`

## نتیجه

✅ مشکل RLS اپراتورها حل شد - حالا می‌توانید اپراتورها را مدیریت کنید
✅ هشدار تغییر پکیج اضافه شد - فروشندگان از باطل شدن پکیج فعلی مطلع می‌شوند
✅ مدیریت اپراتورها در تنظیمات ادمین قابل مشاهده است
✅ اپراتورها در سراسر سایت از دیتابیس خوانده می‌شوند
✅ تغییرات اپراتورها بلافاصله در صفحه اصلی، منوها و فرم ثبت سیمکارت اعمال می‌شود

## دستورات اجرا

```bash
# اجرای SQL در Supabase
# فایل: msim-new/supabase/fix-carriers-rls.sql
```

## تست

1. وارد پنل ادمین شوید
2. به تنظیمات → عمومی بروید
3. بخش "مدیریت اپراتورها" را ببینید
4. اپراتور جدید اضافه کنید (مثلاً "تله کیش")
5. صفحه اصلی را رفرش کنید - اپراتور جدید باید نمایش داده شود
6. اپراتور را غیرفعال کنید - از صفحه اصلی حذف می‌شود
7. به عنوان فروشنده سیمکارت ثبت کنید - اپراتورهای فعال در dropdown نمایش داده می‌شوند

همچنین:
1. به عنوان فروشنده وارد شوید
2. سعی کنید پکیج جدید خریداری کنید
3. پیام هشدار زرد رنگ را مشاهده کنید
