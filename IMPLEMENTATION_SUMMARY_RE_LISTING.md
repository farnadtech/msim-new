# خلاصه پیاده‌سازی: آگهی مجدد شماره‌های فروخته شده

## درخواست کاربر

> "میخوام وقتی حراجی ای تموم میشه یا فروخته میشه دوباره اون فروشنده یا فروشنده دیگه ای بتونه دوباره اون شماره رو اگهی کنه و بعد از اتمام حراجی یا فروش یک خط اگهیش بعد یک روز پاک بشه"

## وضعیت فعلی سیستم

### ✅ قابلیت‌های موجود

1. **سیستم Auto-Cleanup:**
   - Hook: `hooks/useAutoCleanup.ts`
   - تابع: `api.deleteExpiredListings()`
   - اجرا: هر بار که برنامه لود می‌شود
   - عملکرد: سیمکارت‌های فروخته شده قدیمی را حذف می‌کند

2. **تنظیمات قابل تغییر:**
   - کلید: `listing_auto_delete_days`
   - مقدار پیش‌فرض: `30` روز
   - قابل تغییر از: پنل ادمین یا SQL

3. **عدم محدودیت شماره تکراری:**
   - هیچ constraint یا validation برای شماره تکراری وجود ندارد
   - فروشندگان می‌توانند همان شماره را دوباره ثبت کنند
   - فروشندگان مختلف می‌توانند همان شماره را ثبت کنند

## تغییرات انجام شده

### 1. فایل‌های SQL ایجاد شده

**`supabase/update-listing-auto-delete-to-1-day.sql`**
- آپدیت تنظیمات به 1 روز
- قابل اجرا در Supabase SQL Editor

### 2. اسکریپت TypeScript

**`update-auto-delete-settings.ts`**
- آپدیت تنظیمات از طریق کد
- نیاز به دسترسی مناسب (RLS policies)

### 3. مستندات

**`RE-LISTING_FEATURE_GUIDE.md`**
- راهنمای کامل استفاده
- نحوه تغییر تنظیمات
- توضیح فرآیند آگهی مجدد
- نکات و هشدارها

**`IMPLEMENTATION_SUMMARY_RE_LISTING.md`** (این فایل)
- خلاصه تغییرات
- وضعیت پیاده‌سازی

## نحوه استفاده

### مرحله 1: تغییر تنظیمات به 1 روز

**روش توصیه شده: پنل ادمین**

1. وارد پنل ادمین شوید
2. بروید به: **⚙️ تنظیمات سایت**
3. کلیک کنید روی: **📋 آگهی‌ها**
4. پیدا کنید: "مدت زمان حذف خودکار آگهی‌های منقضی شده (روز)"
5. تغییر دهید از `30` به `1`
6. کلیک کنید روی: **ذخیره**

### مرحله 2: تست کردن

**تست سریع:**

```sql
-- 1. یک سیمکارت بفروشید
-- 2. sold_date را به 2 روز پیش تغییر دهید
UPDATE sim_cards 
SET sold_date = NOW() - INTERVAL '2 days'
WHERE id = YOUR_SIM_ID;

-- 3. صفحه را رفرش کنید
-- 4. سیمکارت باید حذف شود
```

**تست آگهی مجدد:**

1. همان شماره را دوباره در فرم ثبت سیمکارت وارد کنید
2. سیمکارت جدید با موفقیت ثبت می‌شود
3. هیچ خطای "شماره تکراری" دریافت نمی‌کنید

## فرآیند کامل

```
┌─────────────────────────────────────────────────────────────┐
│                    فروش سیمکارت                             │
│  status: available → sold                                   │
│  sold_date: 2025-02-13 10:00:00                            │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  بعد از 1 روز                               │
│  Auto-cleanup اجرا می‌شود                                   │
│  سیمکارت از دیتابیس حذف می‌شود                             │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  آگهی مجدد                                  │
│  فروشنده می‌تواند همان شماره را دوباره ثبت کند            │
│  سیمکارت جدید: status = available                          │
└─────────────────────────────────────────────────────────────┘
```

## نکات مهم

### ✅ مزایا

1. **آگهی مجدد آسان:** فروشندگان می‌توانند شماره‌های فروخته شده را دوباره آگهی کنند
2. **دیتابیس تمیز:** آگهی‌های قدیمی فضا نمی‌گیرند
3. **انعطاف‌پذیری:** تنظیمات قابل تغییر از پنل ادمین
4. **حفظ تاریخچه:** جدول `commissions` تاریخچه فروش را نگه می‌دارد

### ⚠️ هشدارها

1. **حذف سریع:** با تنظیم 1 روز، آگهی‌ها خیلی سریع پاک می‌شوند
2. **گزارش‌ها:** اطمینان حاصل کنید گزارش‌های فروش قبل از حذف ذخیره شده‌اند
3. **تاریخچه:** فقط سیمکارت حذف می‌شود، نه تاریخچه فروش

### 📊 جداول تحت تاثیر

- ✅ `sim_cards` - سیمکارت‌های فروخته شده حذف می‌شوند
- ✅ `commissions` - تاریخچه فروش حفظ می‌شود
- ✅ `transactions` - تراکنش‌ها حفظ می‌شوند
- ✅ `purchase_orders` - سفارشات حفظ می‌شوند

## کد مرتبط

### Hook اصلی
```typescript
// hooks/useAutoCleanup.ts
export const useAutoCleanup = () => {
    useEffect(() => {
        const performCleanup = async () => {
            const deletedCount = await api.deleteExpiredListings();
            if (deletedCount > 0) {
                console.log(`✓ ${deletedCount} اعلام منقضی شده حذف شد`);
            }
        };
        performCleanup();
    }, []);
};
```

### تابع حذف
```typescript
// services/api-supabase.ts
export const deleteExpiredListings = async (): Promise<number> => {
    const autoDeleteDays = await settingsService.getListingAutoDeleteDays();
    const daysAgo = new Date(now.getTime() - autoDeleteDays * 24 * 60 * 60 * 1000);
    
    const { data: expiredSims } = await supabase
        .from('sim_cards')
        .select('id')
        .eq('status', 'sold')
        .lt('sold_date', daysAgoIso);
    
    // حذف سیمکارت‌های منقضی شده
    await supabase
        .from('sim_cards')
        .delete()
        .in('id', expiredIds);
    
    return expiredIds.length;
}
```

## تست‌ها

### تست موفق ✅

- [x] سیستم auto-cleanup موجود است
- [x] تنظیمات قابل تغییر هستند
- [x] شماره‌های تکراری مجاز هستند
- [x] فایل‌های SQL و اسکریپت‌ها ایجاد شدند
- [x] مستندات کامل نوشته شد

### تست نیاز به انجام 🔄

- [ ] تغییر تنظیمات به 1 روز از پنل ادمین
- [ ] تست حذف خودکار بعد از 1 روز
- [ ] تست آگهی مجدد همان شماره
- [ ] بررسی حفظ تاریخچه در جدول commissions

## نتیجه‌گیری

✅ **سیستم آماده است!**

تمام قابلیت‌های مورد نیاز از قبل در پروژه وجود دارد:
- سیستم auto-cleanup کار می‌کند
- تنظیمات قابل تغییر هستند
- شماره‌های تکراری مجاز هستند

**تنها کاری که باید انجام شود:**
تغییر تنظیم `listing_auto_delete_days` از `30` به `1` از طریق پنل ادمین.

---

**تاریخ:** 2025-02-13  
**وضعیت:** ✅ آماده برای استفاده  
**نیاز به کد جدید:** ❌ خیر  
**نیاز به تغییر تنظیمات:** ✅ بله (فقط یک تنظیم)
