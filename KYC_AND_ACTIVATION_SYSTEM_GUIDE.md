# راهنمای سیستم احراز هویت (KYC) و کنترل دریافت کد فعال‌سازی

## خلاصه تغییرات

این سیستم سه قابلیت اصلی را پیاده‌سازی می‌کند:

### 1. کنترل دریافت کد فعال‌سازی توسط خریدار
- **پیش‌فرض**: غیرفعال (فقط روش فیزیکی فعال است)
- **قابل تنظیم توسط ادمین**: از طریق تنظیمات سایت
- **مکان تنظیم**: صفحه تنظیمات ادمین > دسته‌بندی "عمومی" > تنظیم `buyer_can_receive_activation_code`

### 2. سیستم احراز هویت (KYC) برای کاربران
- **الزامی برای**: خریداران و فروشندگان (قابل تنظیم جداگانه)
- **مدارک مورد نیاز**:
  - نام و نام خانوادگی
  - کد ملی
  - شماره تماس
  - عکس روی کارت ملی
  - عکس پشت کارت ملی
  - سلفی با کارت ملی (اختیاری)
  - آدرس و شهر (اختیاری)

### 3. پنل مدیریت احراز هویت برای ادمین
- **مسیر**: `/admin/kyc-management`
- **امکانات**:
  - مشاهده تمام درخواست‌های احراز هویت
  - فیلتر بر اساس وضعیت (در انتظار، تایید شده، رد شده)
  - تایید یا رد درخواست‌ها
  - افزودن یادداشت ادمین
  - مشاهده تصاویر مدارک

## فایل‌های ایجاد شده

### 1. فایل‌های دیتابیس (Supabase)
- `supabase/create-kyc-verification-table.sql` - جدول احراز هویت
- `supabase/add-activation-settings.sql` - تنظیمات جدید

### 2. کامپوننت‌ها
- `components/KYCVerificationForm.tsx` - فرم احراز هویت
- `components/KYCGuard.tsx` - محافظ صفحات (نیاز به احراز هویت)
- `components/LineDeliveryMethodModal.tsx` - به‌روزرسانی شده

### 3. صفحات
- `pages/KYCVerificationPage.tsx` - صفحه احراز هویت کاربران
- `pages/AdminKYCManagement.tsx` - پنل مدیریت احراز هویت ادمین

### 4. Hooks و Types
- `hooks/useKYCStatus.ts` - Hook برای بررسی وضعیت احراز هویت
- `types.ts` - به‌روزرسانی شده با تایپ‌های جدید

### 5. به‌روزرسانی‌ها
- `App.tsx` - افزودن روت‌های جدید
- `pages/AdminSettings.tsx` - افزودن دسته‌بندی KYC

## نحوه استفاده

### برای ادمین

#### 1. فعال/غیرفعال کردن دریافت کد فعال‌سازی
```
1. وارد صفحه تنظیمات ادمین شوید
2. روی دسته‌بندی "عمومی" کلیک کنید
3. تنظیم "آیا خریدار می‌تواند کد فعال‌سازی دریافت کند؟" را پیدا کنید
4. آن را فعال یا غیرفعال کنید
5. ذخیره کنید
```

#### 2. مدیریت احراز هویت
```
1. وارد صفحه تنظیمات ادمین شوید
2. روی دسته‌بندی "احراز هویت" کلیک کنید
3. روی دکمه "مشاهده درخواست‌های احراز هویت" کلیک کنید
4. درخواست‌ها را بررسی و تایید/رد کنید
```

#### 3. تنظیمات احراز هویت
تنظیمات زیر در دسترس است:
- `kyc_required`: احراز هویت الزامی است؟
- `kyc_required_for_sellers`: احراز هویت برای فروشندگان الزامی است؟
- `kyc_required_for_buyers`: احراز هویت برای خریداران الزامی است؟
- `kyc_required_message`: پیام نمایش داده شده به کاربران احراز هویت نشده

### برای کاربران (خریدار/فروشنده)

#### 1. احراز هویت
```
1. پس از ثبت نام، به صفحه احراز هویت هدایت می‌شوید
2. فرم را با اطلاعات صحیح پر کنید
3. تصاویر مدارک را آپلود کنید
4. درخواست را ارسال کنید
5. منتظر تایید ادمین بمانید
```

#### 2. خرید سیم‌کارت (پس از احراز هویت)
```
1. سیم‌کارت مورد نظر را انتخاب کنید
2. در صورت فعال بودن، روش تحویل را انتخاب کنید:
   - دریافت کد فعال‌سازی (اگر فعال باشد)
   - دریافت فیزیکی سیم‌کارت
3. خرید را تکمیل کنید
```

## دستورات SQL برای اجرا

### 1. ایجاد جدول احراز هویت
```bash
# در Supabase SQL Editor اجرا کنید:
msim-new/supabase/create-kyc-verification-table.sql
```

### 2. افزودن تنظیمات
```bash
# در Supabase SQL Editor اجرا کنید:
msim-new/supabase/add-activation-settings.sql
```

### 3. ایجاد Storage Bucket برای مدارک
```sql
-- در Supabase SQL Editor اجرا کنید:
INSERT INTO storage.buckets (id, name, public)
VALUES ('kyc-documents', 'kyc-documents', true);

-- تنظیم RLS برای bucket
CREATE POLICY "Users can upload their own KYC documents"
ON storage.objects FOR INSERT
WITH CHECK (
    bucket_id = 'kyc-documents' AND
    auth.uid()::text = (storage.foldername(name))[1]
);

CREATE POLICY "Users can view their own KYC documents"
ON storage.objects FOR SELECT
USING (
    bucket_id = 'kyc-documents' AND
    (
        auth.uid()::text = (storage.foldername(name))[1] OR
        auth.uid() IN (SELECT id FROM users WHERE role = 'admin')
    )
);

CREATE POLICY "Admins can view all KYC documents"
ON storage.objects FOR SELECT
USING (
    bucket_id = 'kyc-documents' AND
    auth.uid() IN (SELECT id FROM users WHERE role = 'admin')
);
```

## نکات مهم

### امنیت
- تمام تصاویر در Supabase Storage ذخیره می‌شوند
- RLS برای محافظت از داده‌ها فعال است
- فقط ادمین‌ها می‌توانند تمام مدارک را ببینند
- کاربران فقط مدارک خود را می‌بینند

### تجربه کاربری
- کاربران احراز هویت نشده نمی‌توانند:
  - سیم‌کارت جدید ثبت کنند (فروشنده)
  - سیم‌کارت خریداری کنند (خریدار)
  - در حراجی شرکت کنند
- پیام‌های واضح برای راهنمایی کاربران نمایش داده می‌شود
- وضعیت احراز هویت به صورت real-time نمایش داده می‌شود

### مدیریت
- ادمین می‌تواند درخواست‌ها را فیلتر کند
- امکان افزودن یادداشت برای هر درخواست
- امکان مشاهده تصاویر در اندازه بزرگ
- تاریخچه کامل تغییرات ذخیره می‌شود

## استفاده از KYCGuard

برای محافظت از صفحات خاص:

```tsx
import KYCGuard from '../components/KYCGuard';

const MyProtectedPage = () => {
    return (
        <KYCGuard requireVerification={true}>
            {/* محتوای صفحه */}
        </KYCGuard>
    );
};
```

## وضعیت‌های احراز هویت

- `pending`: در انتظار بررسی ادمین
- `approved`: تایید شده
- `rejected`: رد شده (کاربر می‌تواند مجددا ارسال کند)

## پشتیبانی

در صورت بروز مشکل:
1. لاگ‌های مرورگر را بررسی کنید
2. RLS policies را در Supabase بررسی کنید
3. Storage bucket را بررسی کنید
4. تنظیمات `site_settings` را بررسی کنید

## به‌روزرسانی‌های آینده

قابلیت‌های پیشنهادی:
- ارسال اعلان به کاربر پس از تایید/رد
- تایید خودکار با OCR
- یکپارچه‌سازی با سرویس‌های احراز هویت
- گزارش‌گیری از آمار احراز هویت
