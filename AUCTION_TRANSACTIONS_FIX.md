# رفع مشکل ثبت تراکنش‌های حراجی

## مشکل

تراکنش‌های مربوط به حراجی (پرداخت حق ضمانت، آزادسازی، پرداخت نهایی) در تاریخچه تراکنش‌های کاربران نمایش داده نمی‌شدند.

## تراکنش‌های حراجی

### 1. پرداخت حق ضمانت (اولین پیشنهاد)
**زمان:** هنگام ثبت اولین پیشنهاد در حراجی
**نوع:** `debit_blocked`
**مبلغ:** 5% قیمت پایه (منفی)
**توضیحات:** "حق ضمانت حراجی سیمکارت XXXXX"
**وضعیت:** ✅ ثبت می‌شود

### 2. آزادسازی حق ضمانت برنده
**زمان:** هنگام تکمیل خرید توسط برنده
**نوع:** `credit_released`
**مبلغ:** مبلغ حق ضمانت (مثبت)
**توضیحات:** "آزادسازی حق ضمانت حراجی سیمکارت XXXXX"
**وضعیت:** ✅ اضافه شد

### 3. بلاک کردن مبلغ نهایی
**زمان:** هنگام تکمیل خرید توسط برنده
**نوع:** `debit_blocked`
**مبلغ:** مبلغ پیشنهاد برنده (منفی)
**توضیحات:** "خرید حراجی سیمکارت XXXXX - در انتظار تحویل خط"
**وضعیت:** ✅ ثبت می‌شود

### 4. برگشت حق ضمانت بازندگان
**زمان:** پس از پایان حراجی
**نوع:** `credit`
**مبلغ:** مبلغ حق ضمانت (مثبت)
**توضیحات:** "برگشت حق ضمانت حراجی"
**وضعیت:** ✅ ثبت می‌شود

### 5. پرداخت نهایی خریدار
**زمان:** پس از تحویل خط
**نوع:** `purchase`
**مبلغ:** مبلغ پیشنهاد - حق ضمانت (منفی)
**توضیحات:** "خرید حراجی سیمکارت XXXXX"
**وضعیت:** ✅ ثبت می‌شود

### 6. دریافت فروشنده
**زمان:** پس از تحویل خط
**نوع:** `sale`
**مبلغ:** مبلغ پیشنهاد - کمیسیون (مثبت)
**توضیحات:** "فروش حراجی سیمکارت XXXXX (کمیسیون: XXX تومان)"
**وضعیت:** ✅ ثبت می‌شود

## تغییرات انجام شده

### 1. فایل: `services/api-supabase.ts`
**تابع:** `completeAuctionPurchaseForWinner`

اضافه شد:
```typescript
// Record transaction for releasing guarantee deposit
if (guaranteeDepositAmount > 0) {
    await supabase
        .from('transactions')
        .insert({
            user_id: buyerId,
            type: 'credit_released',
            amount: guaranteeDepositAmount,
            description: `آزادسازی حق ضمانت حراجی سیمکارت ${simData.number}`,
            date: new Date().toISOString()
        });
}
```

### 2. فایل: `services/auction-guarantee-system.ts`
**تابع:** `processAuctionWinnerPayment`

تغییر داده شد:
```typescript
// قبل:
description: `فروش حراجی سیمکارت ${simData?.number} (کمیسیون: ${commissionAmount})`

// بعد:
description: `فروش حراجی سیمکارت ${simData?.number} (کمیسیون: ${commissionAmount.toLocaleString('fa-IR')} تومان)`
```

## جریان کامل تراکنش‌های حراجی

### مثال: حراجی با قیمت پایه 1,000,000 تومان

1. **کاربر A اولین پیشنهاد 1,200,000 تومان می‌دهد:**
   - تراکنش: `debit_blocked` | -50,000 تومان (5% حق ضمانت)
   - موجودی: 1,000,000 → 1,000,000
   - بلاک شده: 0 → 50,000

2. **کاربر B پیشنهاد 1,500,000 تومان می‌دهد:**
   - تراکنش: `debit_blocked` | -75,000 تومان (5% حق ضمانت)
   - موجودی: 2,000,000 → 2,000,000
   - بلاک شده: 0 → 75,000

3. **حراجی تمام می‌شود - کاربر B برنده است:**
   - کاربر A:
     - تراکنش: `credit` | +50,000 تومان (برگشت حق ضمانت)
     - موجودی: 1,000,000 → 1,000,000
     - بلاک شده: 50,000 → 0

4. **کاربر B خرید را تکمیل می‌کند:**
   - تراکنش 1: `credit_released` | +75,000 تومان (آزادسازی حق ضمانت)
   - تراکنش 2: `debit_blocked` | -1,500,000 تومان (بلاک مبلغ نهایی)
   - موجودی: 2,000,000 → 500,000
   - بلاک شده: 75,000 → 1,500,000

5. **فروشنده خط را تحویل می‌دهد:**
   - کاربر B (خریدار):
     - تراکنش: `purchase` | -1,500,000 تومان
     - موجودی: 500,000 → 500,000
     - بلاک شده: 1,500,000 → 0
   
   - فروشنده:
     - تراکنش: `sale` | +1,470,000 تومان (1,500,000 - 30,000 کمیسیون 2%)
     - موجودی: 0 → 1,470,000

## انواع تراکنش‌ها

| نوع | توضیح | مثبت/منفی |
|-----|-------|-----------|
| `debit_blocked` | بلاک کردن پول | منفی |
| `credit_released` | آزادسازی پول بلاک شده | مثبت |
| `credit` | واریز به حساب | مثبت |
| `purchase` | خرید | منفی |
| `sale` | فروش | مثبت |

## تست

### تست 1: پرداخت حق ضمانت
1. ✅ وارد یک حراجی شوید
2. ✅ اولین پیشنهاد را ثبت کنید
3. ✅ به تاریخچه تراکنش‌ها بروید
4. ✅ تراکنش `debit_blocked` با مبلغ 5% را ببینید

### تست 2: برگشت حق ضمانت
1. ✅ در حراجی شرکت کنید اما برنده نشوید
2. ✅ منتظر پایان حراجی بمانید
3. ✅ به تاریخچه تراکنش‌ها بروید
4. ✅ تراکنش `credit` با برگشت حق ضمانت را ببینید

### تست 3: خرید نهایی
1. ✅ برنده حراجی شوید
2. ✅ خرید را تکمیل کنید
3. ✅ به تاریخچه تراکنش‌ها بروید
4. ✅ تراکنش‌های زیر را ببینید:
   - `credit_released` (آزادسازی حق ضمانت)
   - `debit_blocked` (بلاک مبلغ نهایی)
5. ✅ بعد از تحویل خط:
   - `purchase` (خرید نهایی)

### تست 4: دریافت فروشنده
1. ✅ سیمکارت را در حراجی بگذارید
2. ✅ منتظر فروش بمانید
3. ✅ خط را تحویل دهید
4. ✅ به تاریخچه تراکنش‌ها بروید
5. ✅ تراکنش `sale` با مبلغ دریافتی را ببینید

## خلاصه

✅ تمام تراکنش‌های حراجی حالا در تاریخچه تراکنش‌ها ثبت می‌شوند
✅ انواع تراکنش‌ها صحیح هستند (`debit_blocked`, `credit_released`, `credit`, `purchase`, `sale`)
✅ توضیحات تراکنش‌ها واضح و قابل فهم هستند
✅ مبالغ با فرمت فارسی نمایش داده می‌شوند
